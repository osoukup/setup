# RH PS OSIDB setup playbook
#
#   full installation depends on ansible-prodsec.yml
#   ansible-osidb.yml
---
- name: osidb setup
  hosts: all
  tasks:
    - name: check mandatory variables are defined
      assert:
        that:
          - user is defined

    # assume repository exists in ~/prodsec/osidb
    - name: get osidb dir stats
      stat:
        path: "/home/{{ user }}/prodsec/osidb"
      register: osidb_dir
    - name: setup osidb
      block:
        - name: install deps
          dnf:
            name:
              - gcc
              - krb5-devel
              - libpq-devel
              - make
              - openldap-devel
              - podman
              - podman-compose
              - python3
              - python3-devel
              - tox
            state: present

        - name: setup env file
          file:
            src: "/home/{{ user }}/data/config/dot-env"
            dest: "/home/{{ user }}/prodsec/osidb/.env"
            state: link
          become_user: "{{ user }}"

      when: osidb_dir.stat.exists == true
    - name: report non-existing repo
      fail:
        msg: "osidb repo does not exist"
      when: osidb_dir.stat.exists == false
